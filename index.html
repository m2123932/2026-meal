<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 é›²ç«¯ç²¾ç·»è¦åŠƒè¡¨</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        /* ç¦æ­¢é¸å–èˆ‡ç¸®æ”¾ï¼Œè§£æ±ºæ‰‹æ©Ÿæ“ä½œå¹²æ“¾ */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body { 
            background-color: #1a120b; 
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern-dark.png'); 
            color: #f1e4c3; /* æé«˜æ–‡å­—äº®åº¦ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 10px; margin: 0; overflow: hidden; 
            height: 100vh;
        }

        .header h1 { font-size: 1.4rem; margin: 8px 0; text-shadow: 1px 1px 3px #000; color: #d4af37; }

        .controls { 
            width: 100%; max-width: 500px; display: flex; 
            justify-content: space-between; align-items: center; 
            margin-bottom: 12px; 
        }

        button { 
            background: linear-gradient(135deg, #f9f295, #d4af37); 
            border: none; padding: 12px 20px; font-weight: bold; 
            border-radius: 8px; font-size: 1rem; color: #2c1e14;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        canvas { 
            border: 4px solid #d4af37; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
            background: rgba(15, 10, 5, 0.98); 
            width: 100%; max-width: 500px; 
            height: auto; 
            touch-action: none; /* é—œéµï¼šç¦æ­¢ç€è¦½å™¨è™•ç†è§¸æ§æ»¾å‹•ï¼Œäº¤ç”± JS è™•ç† */
        }

        .hint { color: #d4af37; margin-top: 10px; font-size: 0.85rem; opacity: 0.8; }
    </style>
</head>
<body>

    <div class="header"><h1>ğŸ´ 2026 èœå–®çœ‹æ¿</h1></div>
    
    <div class="controls">
        <button onclick="changeMonth(-1)">â—€ å‰ä¸€æœˆ</button>
        <span id="monthDisplay" style="font-size: 1.3rem; font-weight: 900; letter-spacing: 1px;"></span>
        <button onclick="changeMonth(1)">å¾Œä¸€æœˆ â–¶</button>
    </div>

    <canvas id="calendarCanvas"></canvas>
    
    <p class="hint">â˜ è¼•é»ç·¨è¼¯å…§å®¹ | âœŠ é•·æŒ‰ç§»å‹•ä½ç½®</p>

    <script>
        // --- Firebase é…ç½® (è«‹ç¢ºä¿èˆ‡å…ˆå‰ä¸€è‡´) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3ML8cqPwg6UNpv-uH-KKwppsgKtZ-Hv4",
            authDomain: "mealplanner-972b1.firebaseapp.com",
            databaseURL: "https://mealplanner-972b1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mealplanner-972b1",
            storageBucket: "mealplanner-972b1.firebasestorage.app",
            messagingSenderId: "511929578175",
            appId: "1:511929578175:web:aa6a2680340e4501690c0a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const mealRef = db.ref('meals_v2');

        const canvas = document.getElementById('calendarCanvas');
        const ctx = canvas.getContext('2d');
        const monthDisplay = document.getElementById('monthDisplay');

        // ç‚ºäº†è®“æ‰‹æ©Ÿç•«é¢æ›´æ¸…æ™°ï¼Œæˆ‘å€‘å¢åŠ ç•«å¸ƒçš„è§£æåº¦
        const baseW = 600;
        const baseH = 900; // å¢åŠ é«˜åº¦ï¼Œè®“æ ¼å­è®Šå¤§
        canvas.width = baseW;
        canvas.height = baseH;

        let currentMonth = new Date().getMonth();
        const year = 2026;
        let mealData = {};
        let dragItem = null;
        let lastTap = 0; // ç”¨æ–¼åˆ¤æ–·é»æ“Š

        mealRef.on('value', (snapshot) => {
            mealData = snapshot.val() || {};
            draw();
        });

        function getCell(x, y) {
            const paddingTop = 80;
            const cellW = baseW / 7;
            const cellH = (baseH - paddingTop) / 6;
            const col = Math.floor(x / cellW);
            const row = Math.floor((y - paddingTop) / cellH);
            const firstDay = new Date(year, currentMonth, 1).getDay();
            const day = row * 7 + col - firstDay + 1;
            const isLunch = ((y - paddingTop) % cellH) < (cellH / 2);
            return { day, isLunch, x: col * cellW, y: row * cellH + paddingTop, w: cellW, h: cellH };
        }

        function draw() {
            ctx.clearRect(0, 0, baseW, baseH);
            const months = ["01 JAN", "02 FEB", "03 MAR", "04 APR", "05 MAY", "06 JUN", "07 JUL", "08 AUG", "09 SEP", "10 OCT", "11 NOV", "12 DEC"];
            monthDisplay.innerText = months[currentMonth];

            const daysInMonth = new Date(year, currentMonth + 1, 0).getDate();
            const firstDay = new Date(year, currentMonth, 1).getDay();
            const paddingTop = 80;
            const cellW = baseW / 7;
            const cellH = (baseH - paddingTop) / 6;

            const now = new Date();
            const todayKey = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}`;

            // ç•«é€±æ¨™é¡Œ
            const weeks = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
            ctx.font = "bold 24px Arial";
            weeks.forEach((w, i) => {
                ctx.fillStyle = (i === 0 || i === 6) ? "#ff7e67" : "#d4af37";
                ctx.fillText(w, i * cellW + cellW/2 - 12, 45);
            });

            let dayIdx = 1;
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 7; c++) {
                    if (r === 0 && c < firstDay) continue;
                    if (dayIdx > daysInMonth) break;

                    const x = c * cellW;
                    const y = r * cellH + paddingTop;
                    const dateKey = `${year}-${currentMonth}-${dayIdx}`;

                    // æ ¼å­èƒŒæ™¯
                    ctx.strokeStyle = "rgba(212, 175, 55, 0.4)";
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x+3, y+3, cellW-6, cellH-6);

                    // ä»Šæ—¥é«˜äº®
                    if (dateKey === todayKey) {
                        ctx.fillStyle = "rgba(212, 175, 55, 0.2)";
                        ctx.fillRect(x+3, y+3, cellW-6, cellH-6);
                    }

                    // æ—¥æœŸæ–‡å­— (åŠ å¤§åŠ äº®)
                    ctx.fillStyle = (c === 0 || c === 6) ? "#ff7e67" : "#f1e4c3";
                    ctx.font = "bold 20px Arial";
                    ctx.fillText(dayIdx, x + 12, y + 30);

                    const data = mealData[dateKey] || {};
                    // å…§å®¹é¡¯ç¤º (èª¿æ•´å­—é«”å¤§å°èˆ‡å°æ¯”åº¦)
                    ctx.font = "bold 18px Sans-Serif";
                    if (data.lunch && !(dragItem && dragItem.day === dayIdx && dragItem.type === 'lunch')) {
                        ctx.fillStyle = "#fff176";
                        ctx.fillText("â˜€ï¸" + data.lunch, x + 8, y + 65, cellW - 15);
                    }
                    if (data.dinner && !(dragItem && dragItem.day === dayIdx && dragItem.type === 'dinner')) {
                        ctx.fillStyle = "#ffffff";
                        ctx.fillText("ğŸŒ™" + data.dinner, x + 8, y + 105, cellW - 15);
                    }
                    dayIdx++;
                }
            }

            // æ‹–æ›³ä¸­çš„è¦–è¦ºæ•ˆæœ
            if (dragItem) {
                ctx.save();
                ctx.shadowBlur = 20;
                ctx.shadowColor = "#d4af37";
                ctx.fillStyle = "#f9f295";
                ctx.font = "bold 24px Sans-Serif";
                ctx.fillText("ç§»å‹•: " + dragItem.content, dragItem.currX - 30, dragItem.currY - 20);
                ctx.restore();
            }
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (baseW / rect.width),
                y: (clientY - rect.top) * (baseH / rect.height)
            };
        }

        function handleStart(e) {
            const pos = getMousePos(e);
            const cell = getCell(pos.x, pos.y);
            
            if (cell.day > 0) {
                const dateKey = `${year}-${currentMonth}-${cell.day}`;
                const data = mealData[dateKey];
                const type = cell.isLunch ? 'lunch' : 'dinner';

                // é•·æŒ‰é‚è¼¯æ¨¡æ“¬ (å¦‚æœ 200ms å¾Œé‚„æ²’æ”¾é–‹ï¼Œå‰‡é–‹å•Ÿæ‹–æ›³)
                this.dragTimer = setTimeout(() => {
                    if (data && data[type]) {
                        dragItem = { day: cell.day, type, content: data[type], currX: pos.x, currY: pos.y };
                        if(window.navigator.vibrate) window.navigator.vibrate(50); // éœ‡å‹•åé¥‹
                    }
                }, 300);
            }
        }

        function handleEnd(e) {
            clearTimeout(this.dragTimer);
            if (dragItem) {
                const rect = canvas.getBoundingClientRect();
                const pos = { x: dragItem.currX, y: dragItem.currY };
                const cell = getCell(pos.x, pos.y);

                if (cell.day > 0) {
                    const oldKey = `${year}-${currentMonth}-${dragItem.day}`;
                    const newKey = `${year}-${currentMonth}-${cell.day}`;
                    const newType = cell.isLunch ? 'lunch' : 'dinner';
                    mealRef.child(oldKey).child(dragItem.type).remove();
                    mealRef.child(newKey).update({ [newType]: dragItem.content });
                }
                dragItem = null;
            } else {
                // éæ‹–æ›³ï¼Œè¦–ç‚ºé»æ“Šç·¨è¼¯
                const now = Date.now();
                if (now - lastTap < 300) return; // é˜²æ­¢é‡è¤‡è§¸ç™¼
                lastTap = now;

                const pos = getMousePos(e.changedTouches ? e.changedTouches[0] : e);
                const cell = getCell(pos.x, pos.y);
                if (cell.day > 0) {
                    const type = cell.isLunch ? 'lunch' : 'dinner';
                    const current = (mealData[`${year}-${currentMonth}-${cell.day}`] && mealData[`${year}-${currentMonth}-${cell.day}`][type]) || "";
                    const val = prompt(`${cell.day}æ—¥ ${type==='lunch'?'åˆé¤':'æ™šé¤'}:`, current);
                    if (val !== null) mealRef.child(`${year}-${currentMonth}-${cell.day}`).update({ [type]: val });
                }
            }
            draw();
        }

        function handleMove(e) {
            if (!dragItem) return;
            e.preventDefault(); 
            const pos = getMousePos(e);
            dragItem.currX = pos.x;
            dragItem.currY = pos.y;
            draw();
        }

        // ç¶å®šäº‹ä»¶
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', handleEnd);
        
        // ç›¸å®¹é›»è…¦ç‰ˆ
        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        function changeMonth(s) {
            currentMonth = (currentMonth + s + 12) % 12;
            draw();
        }
    </script>
</body>
</html>
