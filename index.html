<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meal Planner 2026 - Separation Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #d4af37; --bg: #0a0805; --past: #3d3428; --weekend: #ff7e67; }
        body { background: #1a120b; color: var(--gold); font-family: sans-serif; margin: 0; padding: 10px; text-align: center; }
        
        .nav { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto 15px auto; }
        .nav-btn { background: none; border: 1px solid var(--gold); color: var(--gold); padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        
        /* æ¯å¤©åˆ†éš”å¼·åŒ–æ–¹æ¡ˆ */
        table { 
            width: 100%; 
            max-width: 500px; 
            margin: 0 auto; 
            /* é—œéµï¼šé–‹å•Ÿé–“è·ä¸¦è¨­ç½®é–“éš”é«˜åº¦ */
            border-collapse: separate; 
            border-spacing: 0 10px; 
            table-layout: fixed;
        }

        /* è®“æ¯ä¸€è¡Œçœ‹èµ·ä¾†åƒç¨ç«‹çš„å€å¡Š */
        tr { 
            background: var(--bg);
            outline: 1px solid var(--gold); /* ä½¿ç”¨ outline é¿å… border æ“ å£“ */
        }
        
        /* å·¦å´æ—¥æœŸå€å¡Š */
        .date-col { 
            width: 85px; 
            padding: 12px 10px; 
            text-align: left; 
            border-right: 1px solid var(--gold); /* æ˜ŸæœŸèˆ‡é¤é»çš„åˆ†éš”ç·š */
            vertical-align: middle;
        }

        .day-label { font-size: 10px; display: block; opacity: 0.8; margin-bottom: 2px; }
        .date-num { font-size: 30px; font-weight: bold; line-height: 1; }
        
        /* å³å´é¤é»å€å¡Š */
        .meal-col { padding: 10px 15px; text-align: left; vertical-align: middle; }
        .slot { min-height: 38px; display: flex; align-items: center; cursor: pointer; margin: 4px 0; border-radius: 4px; }
        .lunch { color: #eee6ac; border-bottom: 1px dotted rgba(212, 175, 55, 0.2); } /* åˆæ™šé¤é–“å¾®å¼±åˆ†éš” */
        .dinner { color: #ffffff; }
        
        /* ç‹€æ…‹æ¨£å¼ */
        .past { opacity: 0.3; }
        .today { outline: 2px solid #fff !important; background: #2a2015; } /* ä»Šæ—¥åŠ äº®å¤–æ¡† */
        .weekend-row { outline: 1px solid var(--weekend); background: rgba(255, 126, 103, 0.05); }
        .weekend-row .date-num, .weekend-row .day-label, .weekend-row .date-col { color: var(--weekend); border-right-color: var(--weekend); }
        
        .drag-over { background: rgba(212, 175, 55, 0.2) !important; outline: 1px dashed #fff; }
    </style>
</head>
<body>
    <h3 style="letter-spacing: 5px; margin: 10px 0; font-weight: normal;">MENU Â· WEEKLY</h3>
    <div class="nav">
        <button class="nav-btn" onclick="moveWeek(-7)">PREV</button>
        <span id="rangeDisplay" style="font-weight: bold; font-size: 18px;">è¼‰å…¥ä¸­...</span>
        <button class="nav-btn" onclick="moveWeek(7)">NEXT</button>
    </div>
    
    <table id="mealTable"></table>

    <script>
        const config = {
            apiKey: "AIzaSyA3ML8cqPwg6UNpv-uH-KKwppsgKtZ-Hv4",
            authDomain: "mealplanner-972b1.firebaseapp.com",
            databaseURL: "https://mealplanner-972b1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mealplanner-972b1",
            appId: "1:511929578175:web:aa6a2680340e4501690c0a"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let currentMon = new Date();
        let day = currentMon.getDay();
        currentMon.setDate(currentMon.getDate() - (day === 0 ? 6 : day - 1));
        currentMon.setHours(0,0,0,0);
        let dragSrc = null;

        function render() {
            const sun = new Date(currentMon); sun.setDate(sun.getDate() + 6);
            document.getElementById('rangeDisplay').innerText = `${currentMon.getMonth()+1}/${currentMon.getDate()} - ${sun.getMonth()+1}/${sun.getDate()}`;
            
            db.ref('meals_v2').on('value', snap => {
                const data = snap.val() || {};
                const table = document.getElementById('mealTable');
                table.innerHTML = "";
                const labels = ["MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"];
                const today = new Date(); today.setHours(0,0,0,0);

                for (let i = 0; i < 7; i++) {
                    let d = new Date(currentMon); d.setDate(d.getDate() + i);
                    let key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                    let m = data[key] || {};
                    let isWE = (i >= 5);
                    let status = (d < today) ? "past" : (d.getTime() === today.getTime() ? "today" : "");
                    
                    let lTxt = m.lunch ? 'â˜€ï¸ ' + m.lunch : (isWE ? 'â˜€ï¸ -' : '');
                    let dTxt = m.dinner ? 'ğŸŒ™ ' + m.dinner : (isWE ? 'ğŸŒ™ -' : '');

                    table.innerHTML += `<tr class="${status} ${isWE ? 'weekend-row' : ''}">
                        <td class="date-col">
                            <span class="day-label">${labels[i]}</span>
                            <span class="date-num">${d.getDate()}</span>
                        </td>
                        <td class="meal-col">
                            <div class="slot lunch" draggable="true" ondragstart="drag('${key}','lunch','${m.lunch||""}')" 
                                 ondragover="e=>e.preventDefault()" ondrop="drop(event,'${key}','lunch')" onclick="edit('${key}','lunch','${m.lunch||""}')">
                                 ${lTxt}
                            </div>
                            <div class="slot dinner" draggable="true" ondragstart="drag('${key}','dinner','${m.dinner||""}')" 
                                 ondragover="e=>e.preventDefault()" ondrop="drop(event,'${key}','dinner')" onclick="edit('${key}','dinner','${m.dinner||""}')">
                                 ${dTxt}
                            </div>
                        </td>
                    </tr>`;
                }
            });
        }

        function drag(k,t,v) { if(v) dragSrc = {k,t,v}; }
        function drop(e,toK,toT) {
            e.preventDefault();
            if(!dragSrc) return;
            db.ref('meals_v2').child(dragSrc.k).child(dragSrc.t).remove();
            db.ref('meals_v2').child(toK).update({ [toT]: dragSrc.v });
            dragSrc = null;
        }

        function edit(k,t,old) {
            let v = prompt(`ç·¨è¼¯${t==='lunch'?'åˆé¤':'æ™šé¤'}:`, old);
            if (v !== null) {
                if (v.trim()==="") db.ref('meals_v2').child(k).child(t).remove();
                else db.ref('meals_v2').child(k).update({ [t]: v });
            }
        }
        function moveWeek(n) { currentMon.setDate(currentMon.getDate()+n); render(); }
        render();
    </script>
</body>
</html>
