<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 é›²ç«¯æ‹–æ›³è¦åŠƒè¡¨ (æ‰‹æ©Ÿç‰ˆ)</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { 
            background-color: #1a120b; background-image: url('https://www.transparenttextures.com/patterns/wood-pattern-dark.png'); 
            color: #d4af37; font-family: 'PingFang TC', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 10px; margin: 0; overflow-x: hidden; touch-action: none;
        }
        .header h1 { font-size: 1.5rem; margin: 10px 0; text-shadow: 2px 2px 4px #000; }
        .controls { width: 100%; display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; }
        canvas { 
            border: 5px double #d4af37; box-shadow: 0 10px 30px rgba(0,0,0,0.8); 
            background: rgba(20, 15, 10, 0.95); width: 100%; max-width: 600px; height: auto;
        }
        button { 
            background: linear-gradient(135deg, #f9f295, #d4af37); 
            border: none; padding: 10px 15px; font-weight: bold; border-radius: 5px; font-size: 1rem;
        }
        .hint { color: #8a6d3b; margin-top: 10px; font-size: 0.8rem; text-align: center; }
    </style>
</head>
<body>

    <div class="header"><h1>2026 åˆæ™šé¤è¦åŠƒ</h1></div>
    
    <div class="controls">
        <button onclick="changeMonth(-1)">â—€ ä¸Šæœˆ</button>
        <span id="monthDisplay" style="font-size: 1.2rem; font-weight: bold; min-width: 100px; text-align: center;"></span>
        <button onclick="changeMonth(1)">ä¸‹æœˆ â–¶</button>
    </div>

    <canvas id="calendarCanvas"></canvas>
    
    <p class="hint">é•·æŒ‰æ‹–æ›³é¤é» | é»æ“Šç©ºç™½è™•ç·¨è¼¯</p>

    <script>
        // --- Firebase é…ç½® (ç¶­æŒåŸæ¨£) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3ML8cqPwg6UNpv-uH-KKwppsgKtZ-Hv4",
            authDomain: "mealplanner-972b1.firebaseapp.com",
            databaseURL: "https://mealplanner-972b1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mealplanner-972b1",
            storageBucket: "mealplanner-972b1.firebasestorage.app",
            messagingSenderId: "511929578175",
            appId: "1:511929578175:web:aa6a2680340e4501690c0a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const mealRef = db.ref('meals_v2');

        const canvas = document.getElementById('calendarCanvas');
        const ctx = canvas.getContext('2d');
        const monthDisplay = document.getElementById('monthDisplay');

        // è¨­å®šç•«å¸ƒåŸºç¤å°ºå¯¸ (é‚è¼¯å°ºå¯¸)
        const baseW = 600;
        const baseH = 800;
        canvas.width = baseW;
        canvas.height = baseH;

        let currentMonth = new Date().getMonth();
        const year = 2026;
        let mealData = {};
        let dragItem = null;

        mealRef.on('value', (snapshot) => {
            mealData = snapshot.val() || {};
            draw();
        });

        function getCell(x, y) {
            const paddingTop = 70;
            const cellW = baseW / 7;
            const cellH = (baseH - paddingTop) / 6;
            const col = Math.floor(x / cellW);
            const row = Math.floor((y - paddingTop) / cellH);
            const firstDay = new Date(year, currentMonth, 1).getDay();
            const day = row * 7 + col - firstDay + 1;
            const isLunch = ((y - paddingTop) % cellH) < (cellH / 2);
            return { day, isLunch, x: col * cellW, y: row * cellH + paddingTop, w: cellW, h: cellH };
        }

        function draw() {
            ctx.clearRect(0, 0, baseW, baseH);
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            monthDisplay.innerText = `${months[currentMonth]} 2026`;

            const daysInMonth = new Date(year, currentMonth + 1, 0).getDate();
            const firstDay = new Date(year, currentMonth, 1).getDay();
            const paddingTop = 70;
            const cellW = baseW / 7;
            const cellH = (baseH - paddingTop) / 6;

            // é€±æ¨™é¡Œ (ç¸®å¯«é©åˆæ‰‹æ©Ÿ)
            const weeks = ["S", "M", "T", "W", "T", "F", "S"];
            weeks.forEach((w, i) => {
                ctx.fillStyle = "#d4af37";
                ctx.font = "bold 18px Arial";
                ctx.fillText(w, i * cellW + cellW/2 - 5, 40);
            });

            let dayIdx = 1;
            for (let r = 0; r < 6; r++) {
                for (let c = 0; c < 7; c++) {
                    if (r === 0 && c < firstDay) continue;
                    if (dayIdx > daysInMonth) break;

                    const x = c * cellW;
                    const y = r * cellH + paddingTop;
                    
                    // æ ¼å­ç·š
                    ctx.strokeStyle = "rgba(212, 175, 55, 0.2)";
                    ctx.strokeRect(x+2, y+2, cellW-4, cellH-4);

                    // æ—¥æœŸ
                    ctx.fillStyle = "#8a6d3b";
                    ctx.font = "14px Arial";
                    ctx.fillText(dayIdx, x + 8, y + 22);

                    const data = mealData[`${year}-${currentMonth}-${dayIdx}`] || {};
                    // ç¹ªè£½å…§å®¹ (èª¿æ•´å­—é«”èˆ‡é–“è·)
                    if (data.lunch && !(dragItem && dragItem.day === dayIdx && dragItem.type === 'lunch')) {
                        ctx.fillStyle = "#f9f295";
                        ctx.font = "12px Sans-Serif";
                        ctx.fillText("â˜€ï¸" + data.lunch, x + 5, y + 50, cellW - 10);
                    }
                    if (data.dinner && !(dragItem && dragItem.day === dayIdx && dragItem.type === 'dinner')) {
                        ctx.fillStyle = "#ffffff";
                        ctx.font = "12px Sans-Serif";
                        ctx.fillText("ğŸŒ™" + data.dinner, x + 5, y + 85, cellW - 10);
                    }
                    dayIdx++;
                }
            }

            if (dragItem) {
                ctx.fillStyle = "#f9f295aa";
                ctx.font = "bold 16px Sans-Serif";
                ctx.fillText("ğŸ“¦ " + dragItem.content, dragItem.currX, dragItem.currY);
            }
        }

        // åº§æ¨™è½‰æ›å‡½æ•¸ï¼šè™•ç†æ‰‹æ©Ÿç¸®æ”¾å¾Œçš„åº§æ¨™åç§»
        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (baseW / rect.width),
                y: (clientY - rect.top) * (baseH / rect.height)
            };
        }

        function handleStart(e) {
            const pos = getMousePos(e);
            const cell = getCell(pos.x, pos.y);
            if (cell.day > 0) {
                const data = mealData[`${year}-${currentMonth}-${cell.day}`];
                const type = cell.isLunch ? 'lunch' : 'dinner';
                if (data && data[type]) {
                    dragItem = { day: cell.day, type, content: data[type], currX: pos.x, currY: pos.y };
                } else {
                    // å–®æ“Šç·¨è¼¯
                    setTimeout(() => {
                        if(!dragItem) {
                            const val = prompt(`${cell.day}æ—¥ ${type==='lunch'?'åˆé¤':'æ™šé¤'}:`, "");
                            if (val !== null) mealRef.child(`${year}-${currentMonth}-${cell.day}`).update({ [type]: val });
                        }
                    }, 200);
                }
            }
        }

        function handleMove(e) {
            if (!dragItem) return;
            e.preventDefault();
            const pos = getMousePos(e);
            dragItem.currX = pos.x;
            dragItem.currY = pos.y;
            draw();
        }

        function handleEnd(e) {
            if (!dragItem) return;
            const rect = canvas.getBoundingClientRect();
            // æ³¨æ„ï¼šmouseup/touchend çš„åº§æ¨™éœ€è¦å¾è®Šå‹•ä¸­æŠ“å–
            const pos = { x: dragItem.currX, y: dragItem.currY };
            const cell = getCell(pos.x, pos.y);

            if (cell.day > 0) {
                const oldKey = `${year}-${currentMonth}-${dragItem.day}`;
                const newKey = `${year}-${currentMonth}-${cell.day}`;
                const newType = cell.isLunch ? 'lunch' : 'dinner';
                mealRef.child(oldKey).child(dragItem.type).remove();
                mealRef.child(newKey).update({ [newType]: dragItem.content });
            }
            dragItem = null;
            draw();
        }

        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);

        canvas.addEventListener('touchstart', handleStart, {passive: false});
        window.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', handleEnd);

        function changeMonth(s) {
            currentMonth = (currentMonth + s + 12) % 12;
            draw();
        }
    </script>
</body>
</html>
