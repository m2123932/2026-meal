<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meal Planner 2026 - Mobile Touch</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --gold: #c5a059; 
            --gold-light: rgba(197, 160, 89, 0.2);
            --bg: #0f0d0a; 
            --text-main: #e0d5c1;
            --past: #554d44; 
            --weekend: #d9887b; 
        }
        
        body { 
            background: #15120e; 
            color: var(--text-main); 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            padding: 15px; 
            text-align: center;
            overflow-x: hidden;
            touch-action: pan-y; /* å…è¨±å‚ç›´æ²å‹•ï¼Œä½†ç¦æ­¢ç³»çµ±è™•ç†æ‹–æ›³ */
        }
        
        .nav { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto 20px auto; }
        .nav-btn { background: none; border: 1px solid var(--gold-light); color: var(--gold); padding: 8px 18px; border-radius: 15px; cursor: pointer; font-size: 14px; }
        
        table { 
            width: 100%; max-width: 500px; margin: 0 auto; border-collapse: collapse; 
            background: var(--bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--gold-light);
        }

        tr { border-bottom: 1px solid rgba(197, 160, 89, 0.1); }
        .date-col { width: 85px; padding: 20px 12px; text-align: left; border-right: 1px solid rgba(197, 160, 89, 0.1); vertical-align: middle; }
        .day-label { font-size: 13px; display: block; opacity: 0.7; letter-spacing: 1.5px; margin-bottom: 4px; font-weight: 500; }
        .date-num { font-size: 38px; font-weight: 500; line-height: 0.9; color: var(--gold); }
        
        .meal-col { padding: 12px 18px; text-align: left; vertical-align: middle; position: relative; }
        
        /* å¢åŠ æ„Ÿæ‡‰å€é¢ç© */
        .slot { 
            min-height: 45px; display: flex; align-items: center; 
            font-size: 17px; margin: 6px 0; padding: 4px 8px; border-radius: 6px; 
            transition: 0.2s; border: 1px solid transparent;
            user-select: none; -webkit-user-select: none; /* é˜²æ­¢æ‰‹æ©Ÿé¸å–æ–‡å­— */
        }

        /* æ‹–æ›³ä¸­çš„è¦–è¦ºå›é¥‹ */
        .drag-over { background: rgba(197, 160, 89, 0.2) !important; border: 1px dashed var(--gold) !important; }
        
        /* æ‰‹æ©Ÿæ‹–æ›³æ™‚è·Ÿéš¨æ‰‹æŒ‡çš„è™›å½±æ¨£å¼ */
        #drag-proxy {
            position: fixed; pointer-events: none; z-index: 1000;
            background: var(--gold); color: #000; padding: 8px 15px;
            border-radius: 8px; font-size: 16px; opacity: 0.8; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .past { opacity: 0.3; }
        .today { background: rgba(197, 160, 89, 0.08); } 
        .weekend-row { background: rgba(217, 136, 123, 0.02); }
        .weekend-row .date-num, .weekend-row .day-label { color: var(--weekend); }
    </style>
</head>
<body>
    <h3 style="letter-spacing: 5px; margin: 15px 0; font-weight: 300; color: var(--gold);">PLANNER</h3>
    <div class="nav">
        <button class="nav-btn" onclick="moveWeek(-7)">PREV</button>
        <span id="rangeDisplay" style="font-size: 17px; color: var(--gold);">Loading...</span>
        <button class="nav-btn" onclick="moveWeek(7)">NEXT</button>
    </div>
    
    <table id="mealTable"></table>
    <div id="drag-proxy"></div> <script>
        const config = {
            apiKey: "AIzaSyA3ML8cqPwg6UNpv-uH-KKwppsgKtZ-Hv4",
            authDomain: "mealplanner-972b1.firebaseapp.com",
            databaseURL: "https://mealplanner-972b1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mealplanner-972b1",
            appId: "1:511929578175:web:aa6a2680340e4501690c0a"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let currentMon = new Date();
        let day = currentMon.getDay();
        currentMon.setDate(currentMon.getDate() - (day === 0 ? 6 : day - 1));
        currentMon.setHours(0,0,0,0);

        let dragData = null;
        let proxy = document.getElementById('drag-proxy');

        function render() {
            const sun = new Date(currentMon); sun.setDate(sun.getDate() + 6);
            document.getElementById('rangeDisplay').innerText = `${currentMon.getMonth()+1}/${currentMon.getDate()} â€” ${sun.getMonth()+1}/${sun.getDate()}`;
            
            db.ref('meals_v2').on('value', snap => {
                const data = snap.val() || {};
                const table = document.getElementById('mealTable');
                table.innerHTML = "";
                const labels = ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"];
                const today = new Date(); today.setHours(0,0,0,0);

                for (let i = 0; i < 7; i++) {
                    let d = new Date(currentMon); d.setDate(d.getDate() + i);
                    let key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
                    let m = data[key] || {};
                    let isWE = (i >= 5);
                    let status = (d < today) ? "past" : (d.getTime() === today.getTime() ? "today" : "");
                    
                    let lTxt = m.lunch ? 'â˜€ï¸ ' + m.lunch : (isWE ? 'â˜€ï¸ -' : '');
                    let dTxt = m.dinner ? 'ğŸŒ™ ' + m.dinner : (isWE ? 'ğŸŒ™ -' : '');

                    table.innerHTML += `<tr class="${status} ${isWE ? 'weekend-row' : ''}">
                        <td class="date-col">
                            <span class="day-label">${labels[i]}</span>
                            <span class="date-num">${d.getDate()}</span>
                        </td>
                        <td class="meal-col">
                            <div class="slot" 
                                 data-key="${key}" data-type="lunch" data-val="${m.lunch||""}"
                                 ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)"
                                 onclick="edit('${key}','lunch','${m.lunch||""}')">
                                 ${lTxt}
                            </div>
                            <div class="slot" 
                                 data-key="${key}" data-type="dinner" data-val="${m.dinner||""}"
                                 ontouchstart="ts(event)" ontouchmove="tm(event)" ontouchend="te(event)"
                                 onclick="edit('${key}','dinner','${m.dinner||""}')">
                                 ${dTxt}
                            </div>
                        </td>
                    </tr>`;
                }
            });
        }

        // --- æ‰‹æ©Ÿè§¸æ§æ‹–æ›³é‚è¼¯ ---
        let startX, startY;
        function ts(e) {
            const el = e.currentTarget;
            const val = el.getAttribute('data-val');
            if(!val || val === "-") return; // ç©ºçš„ä¸èƒ½æ‹–

            // å»¶é²åˆ¤æ–·ï¼šå¦‚æœæ˜¯çŸ­æŒ‰å‰‡è§¸ç™¼ç·¨è¼¯ï¼Œé•·æŒ‰æ‰è§¸ç™¼æ‹–æ›³ (é€™è£¡æˆ‘å€‘å…ˆç°¡å–®è™•ç†)
            dragData = {
                key: el.getAttribute('data-key'),
                type: el.getAttribute('data-type'),
                val: val
            };
            proxy.innerText = el.innerText;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        }

        function tm(e) {
            if(!dragData) return;
            const x = e.touches[0].clientX;
            const y = e.touches[0].clientY;

            // é¡¯ç¤ºè™›å½±ä¸¦è·Ÿéš¨æ‰‹æŒ‡
            proxy.style.display = 'block';
            proxy.style.left = (x + 10) + 'px';
            proxy.style.top = (y - 40) + 'px';

            // åµæ¸¬æ‰‹æŒ‡ä¸‹æ–¹çš„æ ¼å­ä¸¦åŠ å…¥è¦–è¦ºæ•ˆæœ
            const target = document.elementFromPoint(x, y);
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('drag-over'));
            const slot = target ? target.closest('.slot') : null;
            if(slot) slot.classList.add('drag-over');
            
            // é˜²æ­¢è¢å¹•æ²å‹•
            if(Math.abs(y - startY) > 10) e.preventDefault();
        }

        function te(e) {
            if(!dragData) return;
            proxy.style.display = 'none';
            
            const x = e.changedTouches[0].clientX;
            const y = e.changedTouches[0].clientY;
            const target = document.elementFromPoint(x, y);
            const slot = target ? target.closest('.slot') : null;

            if(slot) {
                const toK = slot.getAttribute('data-key');
                const toT = slot.getAttribute('data-type');
                if(dragData.key !== toK || dragData.type !== toT) {
                    db.ref('meals_v2').child(dragData.key).child(dragData.type).remove();
                    db.ref('meals_v2').child(toK).update({ [toT]: dragData.val });
                }
            }
            
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('drag-over'));
            dragData = null;
        }

        function edit(k, t, old) {
            // ç‚ºäº†ä¸å¹²æ“¾æ‹–æ›³ï¼Œæˆ‘å€‘å¯ä»¥åŠ å€‹åˆ¤æ–·ï¼Œä½† prompt æœƒé˜»å¡ï¼Œé€šå¸¸æ²’å•é¡Œ
            setTimeout(() => {
                if(dragData) return; // æ­£åœ¨æ‹–æ›³å°±ä¸ç·¨è¼¯
                let v = prompt(`ç·¨è¼¯ ${t==='lunch'?'åˆé¤':'æ™šé¤'}:`, old);
                if (v !== null) {
                    if (v.trim()==="") db.ref('meals_v2').child(k).child(t).remove();
                    else db.ref('meals_v2').child(k).update({ [t]: v });
                }
            }, 100);
        }

        function moveWeek(n) { currentMon.setDate(currentMon.getDate()+n); render(); }
        render();
    </script>
</body>
</html>
